<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Minha Carteira Crypto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2a2a2a">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <style>
        :root {
            --neon-green: #00e07f;
            /* Tom de verde mais vibrante (Neon) */
            --neon-blue: #00bfff;
            /* Adicionando um azul complementar sutil */
            --neon-glow: 0 0 10px rgba(0, 224, 127, 0.4), 0 0 20px rgba(0, 224, 127, 0.2);
            --dark-bg: #101010;
            --card-bg: #1c1c1c;
            --header-bg: #1a1a1a;
        }

        /* --- SweetAlert2 customizações (mantidas) --- */
        .swal2-popup {
            background: var(--card-bg) !important;
            border: 2px solid transparent;
            width: auto !important;
            max-width: 90% !important;
            padding: 1rem !important;
            border-radius: 12px !important;
            /* Arredondamento */
        }

        .swal2-title {
            color: #fff !important;
            text-shadow: var(--neon-glow) !important;
            font-size: 1.25rem !important;
        }

        .swal2-confirm {
            background-color: var(--neon-green) !important;
            box-shadow: var(--neon-glow) !important;
            padding: .6rem 1.2rem !important;
            font-size: 1rem !important;
        }

        /* --- Resto do seu CSS atualizado --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: var(--dark-bg);
            color: #e1e1e1;
            font-family: "Segoe UI", sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh
        }

        .carteira {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            max-width: 460px;
            width: 100%;
            margin: 0 auto;
            background: var(--dark-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            /* Sombra sutil na tela toda */
        }

        .header {
            padding: 1.5rem;
            background: var(--header-bg);
            /* Novo: Borda inferior arredondada para melhor transição */
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            margin-bottom: 10px;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .user-logo {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 50%;
            padding: 5px;
            /* Fundo mais escuro para o logo */
        }

        .user-name {
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            /* Alinhamento ajustado para ficar mais limpo */
        }

        .header h1 {
            color: #fff;
            font-size: 1.2rem;
            /* Título um pouco menor */
            font-weight: 400;
            margin-top: -0.5rem;
        }

        .saldo-total {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            cursor: pointer;
            margin-top: 1rem;
            padding: 10px 0;
        }

        .saldo-total .valor {
            font-size: 2.5rem;
            /* Valor maior */
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            /* Sombra de texto sutil */
            user-select: none;
            line-height: 1;
        }

        .saldo-total div:first-child div:first-child {
            font-size: 0.9rem;
            color: #aaa;
            font-weight: 600;
            /* Mais destaque para 'Saldo total' */
        }

        .saldo-total .rendimento {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .saldo-total .rendimento.up {
            color: var(--neon-green);
            color: transparent;
        }

        .saldo-total .rendimento.down {
            color: #ff4545;
            color: transparent;
            /* Vermelho mais forte */
        }

        #btnInstall {
            display: inline-block;
            width: 100%;
            /* Botão em largura total */
            margin: 1rem 0 0 0;
            padding: .8rem;
            background: var(--neon-green);
            color: var(--dark-bg);
            /* Cor de texto escura no neon */
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--neon-glow);
            transition: all .2s;
        }

        #btnInstall:hover {
            box-shadow: 0 0 15px var(--neon-green), 0 0 30px rgba(0, 224, 127, 0.4);
            background: #00ff8c;
        }

        .totais-toggle {
            margin-top: 1.5rem;
            padding: 0;
            font-size: 1rem;
            color: #aaa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }

        .totais-toggle .arrow {
            transition: transform .2s;
            font-size: 0.8rem;
        }

        .totais-toggle.collapsed .arrow {
            transform: rotate(90deg);
            /* Seta para a direita quando expandido */
        }

        .totais-toggle:not(.collapsed) .arrow {
            transform: rotate(-90deg);
            /* Seta para baixo quando recolhido */
        }


        .totais-dia {
            display: none;
            padding: 1rem 0;
            background: transparent;
            font-size: 0.9rem;
            justify-content: space-between;
            border-top: 1px solid #333;
            margin-top: 0.5rem;
        }

        .totais-dia.show {
            display: flex
        }

        .totais-dia .ganho {
            color: var(--neon-green);
        }

        .totais-dia .perda {
            color: #ff4545;
        }

        .lista-coins {
            flex: 1;
            overflow-y: auto;
            padding: 10px 10px;
            /* Reduzido o padding da lista */
        }

        .coin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.2rem;
            margin: 0.5rem 0;
            background: var(--card-bg);
            border: 1px solid #333;
            /* Borda mais suave */
            border-radius: 12px;
            position: relative;
            transition: all .2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            /* Sombra para efeito de cartão */
        }

        .coin:hover {
            background: #242424;
            border-color: var(--neon-green);
        }

        .coin-info {
            display: flex;
            align-items: center
        }

        .coin-img-wrapper {
            position: relative;
            margin-right: 12px;
        }

        .coin-img-wrapper img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            padding: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            /* Sombra na imagem */
        }

        /* Novo: Badge para alertar grandes variações */
        .coin-badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
            z-index: 5;
        }

        .coin-badge.badge-up {
            background: var(--neon-green);
            box-shadow: 0 0 5px var(--neon-green);
        }

        .coin-badge.badge-down {
            background: #ff4545;
            box-shadow: 0 0 5px #ff4545;
        }

        /* Fim do Badge */

        .coin-nome {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff
        }

        .coin-quant {
            font-size: .85rem;
            color: #999
        }

        .coin-valores {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .valor-atual {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            user-select: none
        }

        .var24h {
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .var24h.up {
            color: var(--neon-green);
        }

        .var24h.down {
            color: #ff4545;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 460px;
            left: 50%;
            transform: translateX(-50%);
            height: 64px;
            /* NOVO: Glassmorphism/Efeito Vidro */
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            /* FIM NOVO */
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.8);
            z-index: 100
        }

        .nav-item {
            background: none;
            border: none;
            color: #555;
            /* Cor base mais discreta */
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: .5rem;
            transition: color .3s, transform .2s;
        }

        .nav-item:hover {
            transform: translateY(-2px);
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--neon-green);
            text-shadow: 0 0 5px rgba(0, 224, 127, 0.5);
            /* Glow no ícone ativo/hover */
        }

        .nav-item.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            width: 30px;
            /* Linha de indicação ativa */
            height: 3px;
            background: var(--neon-green);
            border-radius: 2px;
            box-shadow: var(--neon-glow);
            top: unset;
            /* Remove a bolinha, usa a linha */
        }

        /* Scrollbar (mantido) */
        .lista-coins::-webkit-scrollbar {
            width: 6px
        }

        .lista-coins::-webkit-scrollbar-track {
            background: #101010;
        }

        .lista-coins::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
            border: 1px solid #101010;
        }

        .lista-coins {
            scrollbar-width: thin;
            scrollbar-color: #444 #101010;
        }
    </style>
</head>

<body>
    <div id="appContainer" style="display: none; flex-direction: column; min-height: 100vh;">
        <div class="carteira">
            <div class="header">
                <div class="user-header">
                    <img src="https://bisq.network/images/bisq-logo.svg" alt="Logo Bisq" class="user-logo" />
                    <span class="user-name">Ge****e Ba***s</span>
                </div>
                <h1>Minha Carteira</h1>

                <div class="saldo-total" id="toggleSaldoArea">
                    <div>
                        <div style="font-size: 20px;">Saldo total</div>
                    </div>
                    <div class="valor-container">
                        <div class="rendimento up">↑ R$ 0,00</div>
                        <div class="valor" id="valorTotal">R$ 0,00</div>
                    </div>
                </div>

                <div style="display:flex; flex-wrap:wrap;">
                    <button id="btnInstall">Instalar App</button>
                </div>

                <div class="totais-toggle collapsed" id="toggleTotais">
                    <span>Totais do dia</span><span class="arrow">▶</span>
                </div>
                <div class="totais-dia" id="painelTotais">
                    <div class="ganho">Ganho: R$ 0,00</div>
                    <div class="perda">Perda: R$ 0,00</div>
                </div>
            </div>

            <div class="lista-coins" id="listaCoins"></div>
        </div>

        <div class="nav-bar">
            <button class="nav-item"><i class="bi bi-house-fill"></i></button>
            <button class="nav-item"><i class="bi bi-wallet-fill"></i></button>
            <button class="nav-item" id="btnTransfer"><i class="bi bi-arrow-up-right-circle"></i></button>
            <button class="nav-item"><i class="bi bi-list"></i></button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
        if ('Notification' in window) Notification.requestPermission();

        let lastTotal = '';
        let saldoHidden = false;
        const valorTotalEl = document.getElementById('valorTotal');

        document.getElementById('toggleSaldoArea').addEventListener('click', () => {
            saldoHidden = !saldoHidden;
            valorTotalEl.textContent = saldoHidden ? '••••••' : lastTotal;
        });

        function formatBRL(v) {
            return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        const investimentos = [
            { id: 'bitcoin', nome: 'Bitcoin', symbol: 'btc', icon: 'https://assets.coingecko.com/coins/images/1/thumb/bitcoin.png', investido: 448000, threshold: 5, quantidade: 0.76304414 }, // Adicionado quantidade para simulação
            { id: 'ethereum', nome: 'Ethereum', symbol: 'eth', icon: 'https://assets.coingecko.com/coins/images/279/thumb/ethereum.png', investido: 38000, threshold: 4, quantidade: 1.85013876 }, // Adicionado quantidade
            { id: 'solana', nome: 'Solana', symbol: 'sol', icon: 'https://assets.coingecko.com/coins/images/4128/thumb/solana.png', investido: 20000, threshold: 6, quantidade: 20.11647439 }, // Adicionado quantidade
            { id: 'cardano', nome: 'Cardano', symbol: 'ada', icon: 'https://assets.coingecko.com/coins/images/975/thumb/cardano.png', investido: 2000, threshold: 3, quantidade: 15423.9997542 }, // Adicionado quantidade
            { id: 'stellar', nome: 'Stellar', symbol: 'xlm', icon: 'https://assets.coingecko.com/coins/images/100/thumb/Stellar_symbol_black_RGB.png', investido: 3800, threshold: 4, quantidade: 2360.24844720 }, // Adicionado quantidade
            { id: 'monero', nome: 'Monero', symbol: 'xmr', icon: 'https://assets.coingecko.com/coins/images/69/thumb/monero_logo.png', investido: 24000, threshold: 5, quantidade: 13.82584050 }, // Adicionado quantidade
            { id: 'uniswap', nome: 'Uniswap', symbol: 'uni', icon: 'https://assets.coingecko.com/coins/images/12504/thumb/uniswap-uni.png', investido: 5500, threshold: 5, quantidade: 1809.80585719 }, // Adicionado quantidade
            { id: 'aave', nome: 'Aave', symbol: 'aave', icon: 'https://assets.coingecko.com/coins/images/12645/thumb/AAVE.png', investido: 2900, threshold: 4, quantidade: 2.52784993 }, // Adicionado quantidade
            { id: 'matic-network', nome: 'Polygon', symbol: 'matic', icon: 'https://assets.coingecko.com/coins/images/4713/thumb/matic-token-icon.png', investido: 2100, threshold: 4, quantidade: 2000 },
            { id: 'vechain', nome: 'VeChain', symbol: 'vet', icon: 'https://assets.coingecko.com/coins/images/1167/thumb/VeChain-Logo-768x725.png', investido: 8000, threshold: 5, quantidade: 200000 }
        ];


        function carregarCarteiraStorage() {
            const data = sessionStorage.getItem("ultimaCarteira");
            if (!data) return false;

            const saved = JSON.parse(data);

            lastTotal = saved.total;
            valorTotalEl.textContent = saldoHidden ? '••••••' : lastTotal;

            const lista = document.getElementById('listaCoins');
            lista.innerHTML = '';
            saved.investimentos.forEach(inv => {
                const el = document.createElement('div');
                el.className = 'coin';
                el.innerHTML = `
          <div class="coin-info">
            <div class="coin-img-wrapper">
              <img src="${inv.icon}" alt="${inv.nome}">
            </div>
            <div>
              <div class="coin-nome">${inv.nome}</div>
              <div class="coin-quant">${inv.quantidade} ${inv.symbol.toUpperCase()}</div>
            </div>
          </div>
          <div class="coin-valores">
            <div class="valor-atual" data-original="${inv.valorAtual}">${inv.valorAtual}</div>
            <div class="var24h ${inv.pct >= 0 ? 'up' : 'down'}">
              ${inv.pct >= 0 ? '↑' : '↓'} ${inv.variacaoBRL} (${inv.pct.toFixed(2)}%)
            </div>
          </div>`;
                lista.appendChild(el);

                el.querySelector('.valor-atual').addEventListener('click', e => {
                    const span = e.currentTarget;
                    const shown = span.textContent !== '••••••';
                    span.textContent = shown ? '••••••' : span.getAttribute('data-original');
                });
            });
            return true;
        }

        function preCarregarCarteiraSimulada() {
            // Usa os dados fixos 'investido' para um cálculo provisório
            const invTotal = investimentos.reduce((s, x) => s + x.investido, 0);
            const totalFormatado = formatBRL(invTotal);
            lastTotal = totalFormatado;
            valorTotalEl.textContent = totalFormatado;

            const lista = document.getElementById('listaCoins');
            lista.innerHTML = '';

            // Preenche a lista com valores simulados (baseado no investido, para não quebrar o layout)
            investimentos.forEach(inv => {
                // Simula o valor atual da moeda em BRL (usando investido como o valor atual)
                const valorAtualSimulado = inv.investido;
                const valorAtualFormatado = formatBRL(valorAtualSimulado);

                const el = document.createElement('div');
                el.className = 'coin';
                el.innerHTML = `
          <div class="coin-info">
            <div class="coin-img-wrapper">
              <img src="${inv.icon}" alt="${inv.nome}">
            </div>
            <div>
              <div class="coin-nome">${inv.nome}</div>
              <div class="coin-quant">${inv.quantidade.toFixed(8)} ${inv.symbol.toUpperCase()}</div>
            </div>
          </div>
          <div class="coin-valores">
            <div class="valor-atual" data-original="${valorAtualFormatado}">${valorAtualFormatado}</div>
            <div class="var24h up">
              ↑ R$ 0,00 (0.00%)
            </div>
          </div>`;
                lista.appendChild(el);

                el.querySelector('.valor-atual').addEventListener('click', e => {
                    const span = e.currentTarget;
                    const shown = span.textContent !== '••••••';
                    span.textContent = shown ? '••••••' : span.getAttribute('data-original');
                });
            });
        }

        let deferredPrompt;
        const btnInstall = document.getElementById('btnInstall');
        btnInstall.style.display = 'none';
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            if (localStorage.getItem('appInstalled') !== 'true') {
                btnInstall.style.display = 'inline-block';
            }
        });
        btnInstall.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            if (choice.outcome === 'accepted') {
                localStorage.setItem('appInstalled', 'true');
                btnInstall.style.display = 'none';
            }
            deferredPrompt = null;
        });


        async function carregarCarteira() {
            const ids = investimentos.map(c => c.id).join(',');
            const res = await fetch(
                `https://api.coingecko.com/api/v3/coins/markets?vs_currency=brl&ids=${ids}&per_page=20&page=1&sparkline=false&t=${Date.now()}`,
                { cache: 'no-store' }
            );
            if (!res.ok) return console.error('API', res.status);

            const data = await res.json();
            const lista = document.getElementById('listaCoins');
            if (data && data.length > 0) {
                lista.innerHTML = '';
            }

            let total = 0, ganhoDia = 0, perdaDia = 0;
            let carteiraParaSalvar = { total: '', investimentos: [] };

            data.forEach(coin => {
                const inv = investimentos.find(x => x.id === coin.id);
                if (!inv) return;

                inv.current_price = coin.current_price;

                // Cálculo do valor atual baseado na quantidade e preço (mais realista)
                const quantidade = inv.quantidade;
                const valorAtual = quantidade * coin.current_price;

                // Cálculo da variação
                const pct = coin.price_change_percentage_24h;
                // Valor anterior = Valor atual / (1 + (pct/100))
                const valorAnterior = valorAtual / (1 + (pct / 100));
                const variacaoBRL = valorAtual - valorAnterior;

                total += valorAtual;
                variacaoBRL >= 0 ? ganhoDia += variacaoBRL : perdaDia += Math.abs(variacaoBRL);

                const passou = Math.abs(pct) >= inv.threshold;
                const badge = passou ? `<span class="coin-badge ${pct >= 0 ? 'badge-up' : 'badge-down'}"></span>` : '';

                const el = document.createElement('div');
                el.className = 'coin';
                el.innerHTML = `
          <div class="coin-info">
            <div class="coin-img-wrapper">
              <img src="${inv.icon}" alt="${inv.nome}">${badge}
            </div>
            <div>
              <div class="coin-nome">${inv.nome}</div>
              <div class="coin-quant">${quantidade.toFixed(8)} ${coin.symbol.toUpperCase()}</div>
            </div>
          </div>
          <div class="coin-valores">
            <div class="valor-atual" data-original="${formatBRL(valorAtual)}">${formatBRL(valorAtual)}</div>
            <div class="var24h ${pct >= 0 ? 'up' : 'down'}">
              ${pct >= 0 ? '↑' : '↓'} ${formatBRL(variacaoBRL)} (${pct.toFixed(2)}%)
            </div>
          </div>`;
                lista.appendChild(el);

                el.querySelector('.valor-atual').addEventListener('click', e => {
                    const span = e.currentTarget;
                    const shown = span.textContent !== '••••••';
                    span.textContent = shown ? '••••••' : span.getAttribute('data-original');
                });

                carteiraParaSalvar.investimentos.push({
                    nome: inv.nome,
                    icon: inv.icon,
                    quantidade: quantidade.toFixed(8),
                    symbol: coin.symbol,
                    valorAtual: formatBRL(valorAtual),
                    pct: pct,
                    variacaoBRL: formatBRL(variacaoBRL)
                });

                if (passou && Notification.permission === 'granted') {
                    new Notification(`${inv.nome}: variação ${pct.toFixed(2)}%`, {
                        body: `${inv.nome} ${pct >= 0 ? 'subiu' : 'caiu'} ${Math.abs(pct).toFixed(2)}% em 24h.`,
                        icon: inv.icon
                    });
                }
            });

            lastTotal = formatBRL(total);
            if (!saldoHidden) {
                valorTotalEl.textContent = lastTotal || "R$ 0,00";
            }

            // Usa o valor investido (fixo) para calcular o rendimento total, mantido para fins de simulação
            const invTotal = investimentos.reduce((s, x) => s + x.investido, 0);
            const rend = total - invTotal;
            const rEl = document.querySelector('.rendimento');
            rEl.textContent = `${rend >= 0 ? '↑ ' : '↓ '}${formatBRL(Math.abs(rend))}`;
            rEl.classList.toggle('up', rend >= 0);
            rEl.classList.toggle('down', rend < 0);

            document.querySelector('.totais-dia .ganho').textContent = `Ganho: ${formatBRL(ganhoDia)}`;
            document.querySelector('.totais-dia .perda').textContent = `Perda: ${formatBRL(perdaDia)}`;

            carteiraParaSalvar.total = lastTotal;
            sessionStorage.setItem("ultimaCarteira", JSON.stringify(carteiraParaSalvar));


        }

        document.getElementById('toggleTotais').addEventListener('click', () => {
            document.getElementById('painelTotais').classList.toggle('show');
            document.getElementById('toggleTotais').classList.toggle('collapsed');
        });

        document.getElementById('btnTransfer').addEventListener('click', async () => {
            const history = [
                '1BoatSLRHtKNngkdXEeobR76b53LETtpyT',
                '3FZbgi29cpjq2GjdwV8eyHuJJnkLtktZc5',
                '1HB5XMLmzFVj8ALj6mfBsbifRoD4miY36v'
            ];
            const { value: address } = await Swal.fire({
                imageUrl: 'https://bisq.network/images/bisq-logo.svg',
                imageAlt: 'Logo Bisq',
                imageWidth: 40,
                title: 'Endereço de destino',
                html: `<input id="swal-address" list="history" class="swal2-input" placeholder="Endereço ou selecione"><datalist id="history">${history.map(a => `<option value="${a}">`).join('')}</datalist>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Próximo',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const v = document.getElementById('swal-address').value;
                    if (!v) throw 'Endereço obrigatório!';
                    if (!/^([13][a-km-zA-HJ-NP-Z1-9]{25,34})$/.test(v)) throw 'Formato inválido!';
                    return v;
                },
                didOpen: () => document.getElementById('swal-address').focus()
            });
            if (!address) return;

            const btc = investimentos.find(c => c.id === 'bitcoin');
            const { value: amount } = await Swal.fire({
                imageUrl: 'https://bisq.network/images/bisq-logo.svg',
                imageAlt: 'Logo Bisq',
                imageWidth: 40,
                title: 'Quantas moedas deseja transferir?',
                html: `<input id="swal-input-amount" class="swal2-input" type="number" placeholder="0.01" min="0.00000001" step="0.00000001"><div id="swal-equivalent" style="color:#ccc;font-size:.9rem;margin-top:-.5rem;">Equivalente: R$ 0,00</div>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Transferir',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const v = parseFloat(document.getElementById('swal-input-amount').value);
                    if (!v || isNaN(v) || v <= 0) throw 'Quantidade inválida';
                    // Altera a checagem de saldo para usar o novo cálculo (quantidade * preço atual)
                    if (v > btc.quantidade) throw 'Saldo insuficiente';
                    return v;
                },
                didOpen: () => {
                    const inp = document.getElementById('swal-input-amount'),
                        eq = document.getElementById('swal-equivalent');
                    inp.addEventListener('input', () => {
                        const v = parseFloat(inp.value) || 0;
                        // Usa btc.current_price, que é atualizado por carregarCarteira()
                        eq.textContent = `Equivalente: ${formatBRL(v * (btc.current_price || btc.investido))}`;
                    });
                    inp.focus();
                }
            });
            if (!amount) return;

            await Swal.fire({
                imageUrl: 'https://bisq.network/images/bisq-logo.svg',
                imageAlt: 'Logo Bisq',
                imageWidth: 40,
                title: 'Autenticação Ledger',
                html: 'Aguardando confirmação no Ledger por <strong>30</strong> segundos.',
                allowOutsideClick: false,
                showConfirmButton: false,
                timer: 30000,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                    const b = Swal.getHtmlContainer().querySelector('strong');
                    let t = 30;
                    const iv = setInterval(() => b.textContent = --t, 1000);
                    Swal.willClose(() => clearInterval(iv));
                }
            });

            await new Promise(r => setTimeout(r, 50));
            let erro = null;
            try {
                await Promise.race([
                    navigator.credentials.get({
                        publicKey: { challenge: new Uint8Array(32), timeout: 30000, userVerification: 'required' }
                    }),
                    new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 30000))
                ]);
            } catch (e) {
                erro = e;
            }
            Swal.close();
            if (erro) {
                const isTimeout = erro.message === 'timeout';
                return Swal.fire({
                    imageUrl: 'https://bisq.network/images/bisq-logo.svg',
                    imageAlt: 'Logo Bisq',
                    imageWidth: 40,
                    icon: 'error',
                    title: 'Erro',
                    text: isTimeout ? 'Tempo esgotado.' : 'Autenticação não realizada.',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            // Atualiza o saldo localmente após a transferência simulada
            const valorBRL = amount * btc.current_price;
            btc.quantidade = Math.max(0, btc.quantidade - amount);
            carregarCarteira();
            Swal.fire({
                imageUrl: 'https://bisq.network/images/bisq-logo.svg',
                imageAlt: 'Logo Bisq',
                imageWidth: 40,
                icon: 'success',
                title: 'Transferência concluída',
                html: `<p><strong>Endereço:</strong> ${address}</p><p><strong>Quantidade:</strong> ${amount} BTC</p><p><strong>Valor:</strong> ${formatBRL(valorBRL)}</p>`
            });
        });

        // === LÓGICA DE INICIALIZAÇÃO CORRIGIDA ===

        // 1. Tenta carregar o último saldo e a lista salva na sessão.
        const carregouSalvo = carregarCarteiraStorage();

        // 2. Se não carregou nada da sessão, faz o pré-cálculo de todos os investimentos.
        if (!carregouSalvo) {
            preCarregarCarteiraSimulada();
        }

        // 3. O container principal é exibido ANTES do SweetAlert para que o saldo carregado seja visto.
        document.getElementById('appContainer').style.display = 'flex';


        window.addEventListener('load', () => {

            Swal.fire({
                title: 'Validando dispositivo',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading(),
                timer: 3000,
                timerProgressBar: true
            }).then(result => {
                if (result.dismiss === Swal.DismissReason.timer) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Dispositivo autenticado',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        Swal.close();
                        carregarCarteira();
                    });
                }
            });

            setInterval(carregarCarteira, 60000);
        });


        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });
        });
    </script>
</body>

</html>