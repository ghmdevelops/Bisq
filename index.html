<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Minha Carteira Crypto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2a2a2a">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5r+oG+r8m0n2z1u9K5Z+08+J+p8+k5a0m5Q5r0g5+K9z5l5n5p5u5+v5p5u5+v5" crossorigin="anonymous"
        referrerpolicy="no-referrer" />
    <style>
        :root {
            --neon-green: #00e07f;
            /* Tom de verde mais vibrante (Neon) */
            --neon-blue: #00bfff;
            /* Adicionando um azul complementar sutil */
            --neon-glow: 0 0 10px rgba(0, 224, 127, 0.4), 0 0 20px rgba(0, 224, 127, 0.2);
            --dark-bg: #101010;
            --card-bg: #1c1c1c;
            --header-bg: #1a1a1a;
        }

        /* --- SweetAlert2 customizações (mantidas) --- */
        .swal2-popup {
            background: var(--card-bg) !important;
            border: 2px solid transparent;
            width: auto !important;
            max-width: 90% !important;
            padding: 1rem !important;
            border-radius: 12px !important;
            /* Arredondamento */
        }

        .swal2-title {
            color: #fff !important;
            text-shadow: var(--neon-glow) !important;
            font-size: 1.25rem !important;
        }

        .swal2-confirm {
            background-color: var(--neon-green) !important;
            box-shadow: var(--neon-glow) !important;
            padding: .6rem 1.2rem !important;
            font-size: 1rem !important;
        }

        html,
        body {
            overflow-x: hidden;
        }

        /* --- Resto do seu CSS atualizado --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: var(--dark-bg);
            color: #e1e1e1;
            font-family: "Segoe UI", sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh
        }

        .carteira {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            max-width: 460px;
            width: 100%;
            margin: 0 auto;
            background: var(--dark-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            /* Sombra sutil na tela toda */
        }

        .header {
            padding: 1.5rem;
            background: var(--header-bg);
            /* Novo: Borda inferior arredondada para melhor transição */
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            margin-bottom: 10px;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .user-logo {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 50%;
            padding: 5px;
            /* Fundo mais escuro para o logo */
        }

        .user-name {
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            /* Alinhamento ajustado para ficar mais limpo */
        }

        .header h1 {
            color: #fff;
            font-size: 1.2rem;
            /* Título um pouco menor */
            font-weight: 400;
            margin-top: -0.5rem;
        }

        .saldo-total {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            cursor: pointer;
            margin-top: 1rem;
            padding: 10px 0;
        }

        .saldo-total .valor {
            font-size: 2.5rem;
            /* Valor maior */
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            /* Sombra de texto sutil */
            user-select: none;
            line-height: 1;
        }

        .saldo-total div:first-child div:first-child {
            font-size: 0.9rem;
            color: #aaa;
            font-weight: 600;
            /* Mais destaque para 'Saldo total' */
        }

        .saldo-total .rendimento {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .saldo-total .rendimento.up {
            color: var(--neon-green);
            color: transparent;
        }

        .saldo-total .rendimento.down {
            color: #ff4545;
            color: transparent;
            /* Vermelho mais forte */
        }

        #btnInstall {
            display: inline-block;
            width: 100%;
            /* Botão em largura total */
            margin: 1rem 0 0 0;
            padding: .8rem;
            background: var(--neon-green);
            color: var(--dark-bg);
            /* Cor de texto escura no neon */
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--neon-glow);
            transition: all .2s;
        }

        #btnInstall:hover {
            box-shadow: 0 0 15px var(--neon-green), 0 0 30px rgba(0, 224, 127, 0.4);
            background: #00ff8c;
        }

        .totais-toggle {
            margin-top: 1.5rem;
            padding: 0;
            font-size: 1rem;
            color: #aaa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }

        .totais-toggle .arrow {
            transition: transform .2s;
            font-size: 0.8rem;
        }

        .totais-toggle.collapsed .arrow {
            transform: rotate(90deg);
            /* Seta para a direita quando expandido */
        }

        .totais-toggle:not(.collapsed) .arrow {
            transform: rotate(-90deg);
            /* Seta para baixo quando recolhido */
        }


        .totais-dia {
            display: none;
            padding: 1rem 0;
            background: transparent;
            font-size: 0.9rem;
            justify-content: space-between;
            border-top: 1px solid #333;
            margin-top: 0.5rem;
        }

        .totais-dia.show {
            display: flex
        }

        .totais-dia .ganho {
            color: var(--neon-green);
        }

        .totais-dia .perda {
            color: #ff4545;
        }

        .lista-coins {
            flex: 1;
            overflow-y: auto;
            padding: 10px 10px;
            /* Reduzido o padding da lista */
        }

        .coin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.2rem;
            margin: 0.5rem 0;
            background: var(--card-bg);
            border: 1px solid #333;
            /* Borda mais suave */
            border-radius: 12px;
            position: relative;
            transition: all .2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            /* Sombra para efeito de cartão */
        }

        .coin:hover {
            background: #242424;
            border-color: var(--neon-green);
        }

        .coin-info {
            display: flex;
            align-items: center
        }

        .coin-img-wrapper {
            position: relative;
            margin-right: 12px;
        }

        .coin-img-wrapper img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            padding: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            /* Sombra na imagem */
        }

        /* Novo: Badge para alertar grandes variações */
        .coin-badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
            z-index: 5;
        }

        .coin-badge.badge-up {
            background: var(--neon-green);
            box-shadow: 0 0 5px var(--neon-green);
        }

        .coin-badge.badge-down {
            background: #ff4545;
            box-shadow: 0 0 5px #ff4545;
        }

        /* Fim do Badge */

        .coin-nome {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff
        }

        .coin-quant {
            font-size: .85rem;
            color: #999
        }

        .coin-valores {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .valor-atual {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            user-select: none
        }

        .var24h {
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .var24h.up {
            color: var(--neon-green);
        }

        .var24h.down {
            color: #ff4545;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 460px;
            left: 50%;
            transform: translateX(-50%);
            height: 64px;
            /* NOVO: Glassmorphism/Efeito Vidro */
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            /* FIM NOVO */
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.8);
            z-index: 100
        }

        .nav-item {
            background: none;
            border: none;
            color: #555;
            /* Cor base mais discreta */
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: .5rem;
            transition: color .3s, transform .2s;
        }

        .nav-item:hover {
            transform: translateY(-2px);
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--neon-green);
            text-shadow: 0 0 5px rgba(0, 224, 127, 0.5);
            /* Glow no ícone ativo/hover */
        }

        .nav-item.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            width: 30px;
            /* Linha de indicação ativa */
            height: 3px;
            background: var(--neon-green);
            border-radius: 2px;
            box-shadow: var(--neon-glow);
            top: unset;
            /* Remove a bolinha, usa a linha */
        }

        /* Scrollbar (mantido) */
        .lista-coins::-webkit-scrollbar {
            width: 6px
        }

        .lista-coins::-webkit-scrollbar-track {
            background: #101010;
        }

        .lista-coins::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
            border: 1px solid #101010;
        }

        .lista-coins {
            scrollbar-width: thin;
            scrollbar-color: #444 #101010;
        }

        .coin-valores .toggle-coin-icon {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="appContainer" style="display: none; flex-direction: column; min-height: 100vh;">
        <div class="carteira">
            <div class="header">
                <div class="user-header">
                    <img src="https://bisq.network/images/bisq-logo.svg" alt="Logo Bisq" class="user-logo" />
                    <span class="user-name" id="userNameDisplay" data-full-name="Gehaime Barros">
                        <i class="bi bi-person-circle" style="color: #00e07f; margin-right: 8px;"></i>
                        Ge****e Ba***s
                    </span>
                </div>
                <h1>
                    <i class="bi bi-wallet-fill" style="color: var(--neon-green); margin-right: 8px;"></i>
                    Minha Carteira
                </h1>

                <div class="saldo-total" id="toggleSaldoArea">
                    <div>
                        <div style="font-size: 20px;">
                            Saldo
                        </div>
                    </div>
                    <div class="valor-container">
                        <div class="rendimento up">↑ R$ 0,00</div>
                        <div class="valor" id="valorTotal">R$ 0,00</div>
                    </div>
                </div>

                <div style="display:flex; flex-wrap:wrap;">
                    <button id="btnInstall">Instalar App</button>
                </div>

                <div class="totais-toggle collapsed" id="toggleTotais">
                    <span>Totais do dia</span><span class="arrow">▶</span>
                </div>
                <div class="totais-dia" id="painelTotais">
                    <div class="ganho">Ganho: R$ 0,00</div>
                    <div class="perda">Perda: R$ 0,00</div>
                </div>

                <div class="user-area">
                    <div class="crypto-count" style="margin-top: 7px;">
                        <i class="bi bi-coin" style="color: var(--neon-green); margin-right: 5px;"></i>
                        Moedas na Carteira <span id="totalMoedasInvestidas"></span>
                    </div>
                </div>
            </div>

            <div class="lista-coins" id="listaCoins"></div>
        </div>

        <div class="nav-bar">
            <button class="nav-item"><i class="bi bi-house-fill"></i></button>
            <button class="nav-item"><i class="bi bi-wallet-fill"></i></button>
            <button class="nav-item" id="btnTransfer"><i class="bi bi-arrow-up-right-circle"></i></button>
            <button class="nav-item"><i class="bi bi-list"></i></button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
        if ('Notification' in window) Notification.requestPermission();

        let lastTotal = '';
        let saldoHidden = true;

        const valorTotalEl = document.getElementById('valorTotal');
        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const rendimentoEl = document.querySelector('.rendimento');

        let nameHidden = true;
        const hiddenName = userNameDisplayEl.textContent;
        const fullName = userNameDisplayEl.getAttribute('data-full-name');

        const ganhoDiaEl = document.querySelector('.totais-dia .ganho');
        const perdaDiaEl = document.querySelector('.totais-dia .perda');


        function formatBRL(v) {
            return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        const investimentos = [
            { id: 'bitcoin', nome: 'Bitcoin', symbol: 'btc', icon: 'https://assets.coingecko.com/coins/images/1/thumb/bitcoin.png', investido: 448000, threshold: 5, quantidade: 0.76304414, transferivel: true },
            { id: 'ethereum', nome: 'Ethereum', symbol: 'eth', icon: 'https://assets.coingecko.com/coins/images/279/thumb/ethereum.png', investido: 38000, threshold: 4, quantidade: 1.85013876, transferivel: true },
            { id: 'solana', nome: 'Solana', symbol: 'sol', icon: 'https://assets.coingecko.com/coins/images/4128/thumb/solana.png', investido: 20000, threshold: 6, quantidade: 20.11647439, transferivel: true },
            { id: 'cardano', nome: 'Cardano', symbol: 'ada', icon: 'https://assets.coingecko.com/coins/images/975/thumb/cardano.png', investido: 2000, threshold: 3, quantidade: 15423.9997542, transferivel: true },
            { id: 'stellar', nome: 'Stellar', symbol: 'xlm', icon: 'https://assets.coingecko.com/coins/images/100/thumb/Stellar_symbol_black_RGB.png', investido: 3800, threshold: 4, quantidade: 2360.24844720, transferivel: true },
            { id: 'monero', nome: 'Monero', symbol: 'xmr', icon: 'https://assets.coingecko.com/coins/images/69/thumb/monero_logo.png', investido: 24000, threshold: 5, quantidade: 13.82584050, transferivel: true },
            { id: 'uniswap', nome: 'Uniswap', symbol: 'uni', icon: 'https://assets.coingecko.com/coins/images/12504/thumb/uniswap-uni.png', investido: 5500, threshold: 5, quantidade: 1809.80585719, transferivel: true },
            { id: 'aave', nome: 'Aave', symbol: 'aave', icon: 'https://assets.coingecko.com/coins/images/12645/thumb/AAVE.png', investido: 2900, threshold: 4, quantidade: 2.52784993, transferivel: true },
            { id: 'matic-network', nome: 'Polygon', symbol: 'matic', icon: 'https://assets.coingecko.com/coins/images/4713/thumb/matic-token-icon.png', investido: 2100, threshold: 4, quantidade: 2000, transferivel: true },
            { id: 'vechain', nome: 'VeChain', symbol: 'vet', icon: 'https://assets.coingecko.com/coins/images/1167/thumb/VeChain-Logo-768x725.png', investido: 8000, threshold: 5, quantidade: 200000, transferivel: true }
        ];

        function simularCliqueTransferir() {
            const btnTransfer = document.getElementById('btnTransfer');
            const navItems = document.querySelectorAll('.nav-item');

            if (btnTransfer) {
                navItems.forEach(i => i.classList.remove('active'));
                btnTransfer.classList.add('active');
            }
        }

        function toggleSingleCoinValue(element) {
            const valorSpan = element.querySelector('.valor-atual');
            const iconSpan = element.querySelector('.toggle-coin-icon');

            const isHidden = valorSpan.textContent === '••••••';
            const originalValue = valorSpan.getAttribute('data-original');

            if (isHidden) {
                valorSpan.textContent = originalValue;
                if (iconSpan) iconSpan.textContent = 'visibility';
                element.setAttribute('data-visible', 'true');
            } else {
                valorSpan.textContent = '••••••';
                if (iconSpan) iconSpan.textContent = 'visibility_off';
                element.setAttribute('data-visible', 'false');
            }
        }


        const toggleMainIconEl = document.getElementById('toggleMainIcon');

        function toggleMainSaldo() {
            saldoHidden = !saldoHidden;

            valorTotalEl.textContent = saldoHidden ? '••••••' : lastTotal;

            const originalRendimento = rendimentoEl.getAttribute('data-original-text');
            const originalGanho = ganhoDiaEl.getAttribute('data-original');
            const originalPerda = perdaDiaEl.getAttribute('data-original');

            if (saldoHidden) {
                rendimentoEl.textContent = rendimentoEl.textContent.includes('↑') ? '↑ ••••••' : '↓ ••••••';
            } else {
                rendimentoEl.textContent = originalRendimento;
            }

            ganhoDiaEl.textContent = saldoHidden ? 'Ganho: ••••••' : `Ganho: ${originalGanho}`;
            perdaDiaEl.textContent = saldoHidden ? 'Perda: ••••••' : `Perda: ${originalPerda}`;

            if (toggleMainIconEl) {
                toggleMainIconEl.textContent = saldoHidden ? 'visibility_off' : 'visibility';
            }
        }

        document.getElementById('toggleSaldoArea').addEventListener('click', toggleMainSaldo);

        userNameDisplayEl.addEventListener('click', () => {
            nameHidden = !nameHidden;
            userNameDisplayEl.textContent = nameHidden ? hiddenName : fullName;
        });

        function setupCoinClickEvent(el, coinData, currentPrice) {
            el.addEventListener('click', () => {
                simularCliqueTransferir();
                abrirModalTransferencia(coinData, currentPrice || 0);
            });
        }

        function carregarCarteiraStorage() {
            const data = sessionStorage.getItem("ultimaCarteira");
            if (!data) return false;

            const saved = JSON.parse(data);
            lastTotal = saved.total;
            valorTotalEl.textContent = saldoHidden ? '••••••' : lastTotal;
            ganhoDiaEl.setAttribute('data-original', saved.ganho);
            perdaDiaEl.setAttribute('data-original', saved.perda);
            ganhoDiaEl.textContent = saldoHidden ? 'Ganho: ••••••' : `Ganho: ${saved.ganho}`;
            perdaDiaEl.textContent = saldoHidden ? 'Perda: ••••••' : `Perda: ${saved.perda}`;

            const lista = document.getElementById('listaCoins');
            lista.innerHTML = '';
            saved.investimentos.forEach(inv => {
                const coinData = investimentos.find(c => c.id === inv.id || c.symbol.toLowerCase() === inv.symbol.toLowerCase());

                const el = document.createElement('div');
                el.className = 'coin';
                if (coinData && coinData.transferivel) {
                    el.classList.add('transferivel');
                }

                const valorDisplay = '••••••';

                el.innerHTML = `
            <div class="coin-info">
                <div class="coin-img-wrapper">
                    <img src="${inv.icon}" alt="${inv.nome}">
                </div>
                <div>
                    <div class="coin-nome">${inv.nome}</div>
                    <div class="coin-quant">${inv.quantidade} ${inv.symbol.toUpperCase()}</div>
                </div>
            </div>
            <div class="coin-valores" data-visible="false">
                <div class="valor-atual" data-original="${inv.valorAtual}">${valorDisplay}</div>
                <div class="var24h ${inv.pct >= 0 ? 'up' : 'down'}">
                    ${inv.pct >= 0 ? '↑' : '↓'} ${inv.variacaoBRL} (${inv.pct.toFixed(2)}%)
                </div>
                <span class="material-icons-outlined toggle-coin-icon">visibility_off</span>
            </div>`;

                const valorAreaEl = el.querySelector('.coin-valores');
                valorAreaEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSingleCoinValue(valorAreaEl);
                });

                if (coinData && coinData.transferivel) {
                    setupCoinClickEvent(el, coinData, inv.current_price);
                }

                lista.appendChild(el);
            });

            const rend = parseFloat(saved.rend.replace(/[R$.,]/g, '').replace(' ', '')) / 100;
            const rEl = document.querySelector('.rendimento');
            const rendText = `${rend >= 0 ? '↑ ' : '↓ '}${formatBRL(Math.abs(rend))}`;
            rEl.setAttribute('data-original-text', rendText);
            rEl.textContent = saldoHidden ? (rend >= 0 ? '↑ ••••••' : '↓ ••••••') : rendText;
            rEl.classList.toggle('up', rend >= 0);
            rEl.classList.toggle('down', rend < 0);

            return true;
        }

        function preCarregarCarteiraSimulada() {
            const invTotal = investimentos.reduce((s, x) => s + x.investido, 0);
            const totalFormatado = formatBRL(invTotal);
            lastTotal = totalFormatado;
            valorTotalEl.textContent = saldoHidden ? '••••••' : totalFormatado;
            const rEl = document.querySelector('.rendimento');
            const rendText = `↑ R$ 0,00`;
            rEl.setAttribute('data-original-text', rendText);
            rEl.textContent = saldoHidden ? '↑ ••••••' : rendText;
            rEl.classList.add('up');
            ganhoDiaEl.setAttribute('data-original', formatBRL(0));
            perdaDiaEl.setAttribute('data-original', formatBRL(0));
            ganhoDiaEl.textContent = saldoHidden ? 'Ganho: ••••••' : `Ganho: ${formatBRL(0)}`;
            perdaDiaEl.textContent = saldoHidden ? 'Perda: ••••••' : `Perda: ${formatBRL(0)}`;


            const lista = document.getElementById('listaCoins');
            lista.innerHTML = '';

            investimentos.forEach(inv => {
                const valorAtualSimulado = inv.investido;
                const valorAtualFormatado = formatBRL(valorAtualSimulado);

                const valorDisplay = '••••••';

                const el = document.createElement('div');
                el.className = 'coin';
                if (inv.transferivel) {
                    el.classList.add('transferivel');
                }
                el.innerHTML = `
            <div class="coin-info">
                <div class="coin-img-wrapper">
                    <img src="${inv.icon}" alt="${inv.nome}">
                </div>
                <div>
                    <div class="coin-nome">${inv.nome}</div>
                    <div class="coin-quant">${inv.quantidade.toFixed(8)} ${inv.symbol.toUpperCase()}</div>
                </div>
            </div>
            <div class="coin-valores" data-visible="false">
                <div class="valor-atual" data-original="${valorAtualFormatado}">${valorDisplay}</div>
                <div class="var24h up">
                    ↑ R$ 0,00 (0.00%)
                </div>
                <span class="material-icons-outlined toggle-coin-icon">visibility_off</span>
            </div>`;

                const valorAreaEl = el.querySelector('.coin-valores');
                valorAreaEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSingleCoinValue(valorAreaEl);
                });

                if (inv.transferivel) {
                    setupCoinClickEvent(el, inv, valorAtualSimulado / inv.quantidade);
                }

                lista.appendChild(el);
            });
        }

        let deferredPrompt;
        const btnInstall = document.getElementById('btnInstall');
        btnInstall.style.display = 'none';
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            if (localStorage.getItem('appInstalled') !== 'true') {
                btnInstall.style.display = 'inline-block';
            }
        });
        btnInstall.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            if (choice.outcome === 'accepted') {
                localStorage.setItem('appInstalled', 'true');
                btnInstall.style.display = 'none';
            }
            deferredPrompt = null;
        });


        async function carregarCarteira() {
            const ids = investimentos.map(c => c.id).join(',');
            const res = await fetch(
                `https://api.coingecko.com/api/v3/coins/markets?vs_currency=brl&ids=${ids}&per_page=20&page=1&sparkline=false&t=${Date.now()}`,
                { cache: 'no-store' }
            );
            if (!res.ok) return;

            const data = await res.json();
            const lista = document.getElementById('listaCoins');
            if (data && data.length > 0) {
                lista.innerHTML = '';
            }

            let total = 0, ganhoDia = 0, perdaDia = 0;
            let carteiraParaSalvar = { total: '', investimentos: [], ganho: '', perda: '', rend: '' };

            data.forEach(coin => {
                const inv = investimentos.find(x => x.id === coin.id);
                if (!inv) return;

                inv.current_price = coin.current_price;

                const quantidade = inv.quantidade;
                const valorAtual = quantidade * coin.current_price;
                const pct = coin.price_change_percentage_24h;
                const valorAnterior = valorAtual / (1 + (pct / 100));
                const variacaoBRL = valorAtual - valorAnterior;
                total += valorAtual;

                if (variacaoBRL >= 0) {
                    ganhoDia += variacaoBRL;
                } else {
                    perdaDia += Math.abs(variacaoBRL);
                }

                const passou = Math.abs(pct) >= inv.threshold;
                const badge = passou ? `<span class="coin-badge ${pct >= 0 ? 'badge-up' : 'badge-down'}"></span>` : '';
                const valorAtualFormatado = formatBRL(valorAtual);
                const valorDisplay = '••••••';

                const el = document.createElement('div');
                el.className = 'coin';
                if (inv.transferivel) {
                    el.classList.add('transferivel');
                }
                el.innerHTML = `
            <div class="coin-info">
                <div class="coin-img-wrapper">
                    <img src="${inv.icon}" alt="${inv.nome}">${badge}
                </div>
                <div>
                    <div class="coin-nome">${inv.nome}</div>
                    <div class="coin-quant">${quantidade.toFixed(8)} ${coin.symbol.toUpperCase()}</div>
                </div>
            </div>
            <div class="coin-valores" data-visible="false">
                <div class="valor-atual" data-original="${valorAtualFormatado}">${valorDisplay}</div>
                <div class="var24h ${pct >= 0 ? 'up' : 'down'}">
                    ${pct >= 0 ? '↑' : '↓'} ${formatBRL(variacaoBRL)} (${pct.toFixed(2)}%)
                </div>
                <span class="material-icons-outlined toggle-coin-icon">visibility_off</span>
            </div>`;

                const valorAreaEl = el.querySelector('.coin-valores');
                valorAreaEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSingleCoinValue(valorAreaEl);
                });

                if (inv.transferivel) {
                    setupCoinClickEvent(el, inv, inv.current_price);
                }

                lista.appendChild(el);

                carteiraParaSalvar.investimentos.push({
                    id: inv.id,
                    nome: inv.nome,
                    icon: inv.icon,
                    quantidade: quantidade.toFixed(8),
                    symbol: coin.symbol,
                    valorAtual: valorAtualFormatado,
                    pct: pct,
                    variacaoBRL: formatBRL(variacaoBRL),
                    current_price: inv.current_price
                });

                if (passou && Notification.permission === 'granted') {
                    new Notification(`${inv.nome}: variação ${pct.toFixed(2)}%`, {
                        body: `${inv.nome} ${pct >= 0 ? 'subiu' : 'caiu'} ${Math.abs(pct).toFixed(2)}% em 24h.`,
                        icon: inv.icon
                    });
                }
            });

            lastTotal = formatBRL(total);
            valorTotalEl.textContent = saldoHidden ? '••••••' : lastTotal || "R$ 0,00";
            const invTotal = investimentos.reduce((s, x) => s + x.investido, 0);
            const rend = total - invTotal;
            const rEl = document.querySelector('.rendimento');
            const rendText = `${rend >= 0 ? '↑ ' : '↓ '}${formatBRL(Math.abs(rend))}`;
            rEl.setAttribute('data-original-text', rendText);
            rEl.textContent = saldoHidden ? (rend >= 0 ? '↑ ••••••' : '↓ ••••••') : rendText;
            rEl.classList.toggle('up', rend >= 0);
            rEl.classList.toggle('down', rend < 0);
            const ganhoBRL = formatBRL(ganhoDia);
            const perdaBRL = formatBRL(perdaDia);
            ganhoDiaEl.setAttribute('data-original', ganhoBRL);
            perdaDiaEl.setAttribute('data-original', perdaBRL);
            ganhoDiaEl.textContent = saldoHidden ? `Ganho: ••••••` : `Ganho: ${ganhoBRL}`;
            perdaDiaEl.textContent = saldoHidden ? `Perda: ••••••` : `Perda: ${perdaBRL}`;
            carteiraParaSalvar.total = lastTotal;
            carteiraParaSalvar.ganho = ganhoBRL;
            carteiraParaSalvar.perda = perdaBRL;
            carteiraParaSalvar.rend = rendText;
            sessionStorage.setItem("ultimaCarteira", JSON.stringify(carteiraParaSalvar));
            if (toggleMainIconEl) {
                toggleMainIconEl.textContent = saldoHidden ? 'visibility_off' : 'visibility';
            }
        }

        document.getElementById('toggleTotais').addEventListener('click', () => {
            document.getElementById('painelTotais').classList.toggle('show');
            document.getElementById('toggleTotais').classList.toggle('collapsed');
        });

        async function abrirModalTransferencia(coin, currentPrice) {
            const history = [
                '1BoatSLRHtKNngkdXEeobR76b53LETtpyT',
                '3FZbgi29cpjq2GjdwV8eyHuJJnkLtktZc5',
                '1HB5XMLmzFVj8ALj6mfBsbifRoD4miY36v'
            ];

            const coinSymbol = coin.symbol.toUpperCase();
            const coinName = coin.nome;

            const { value: address } = await Swal.fire({
                imageUrl: coin.icon,
                imageAlt: `Logo ${coinName}`,
                imageWidth: 50,
                title: `<span style="font-size:1.1rem;font-weight:600;">Chave de destino (${coinSymbol})</span>`,
                background: '#1b1b1b',
                color: '#fff',
                html: `
            <input id="swal-address" list="history" class="swal2-input"
                placeholder="Ex: Endereço ${coinSymbol}" autocomplete="off"
                style="border-radius: 10px;
                        background: #111;
                        border: 1px solid #333;
                        color: #fff;
                        width: 70%;
                        height: 50px;
                        overflow: hidden;
                        scrollbar-width: none;
                        -ms-overflow-style: none;
                        text-align: center;">
            
            <datalist id="history">
                ${history.map(a => `<option value="${a}">`).join('')}
            </datalist>

            <div id="preview" style="font-size:.85rem;margin-top:5px;color:#8ae2fc;"></div>
        `,
                showCancelButton: true,
                confirmButtonText: 'Próximo ➜',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const v = document.getElementById('swal-address').value.trim();
                    if (!v) {
                        Swal.showValidationMessage(`Por favor, digite uma chave de destino ${coinSymbol}.`);
                        return false;
                    }
                    return v;
                },
                didOpen: () => {
                    const inp = document.getElementById('swal-address');
                    const prev = document.getElementById('preview');
                    inp.addEventListener('input', () => {
                        prev.textContent = inp.value.trim()
                            ? `→ Enviando ${coinSymbol} para ${inp.value.slice(0, 12)}...`
                            : '';
                    });
                    inp.focus();

                    inp.style.overflow = 'hidden';
                }
            });
            if (!address) return;

            const { value: amount } = await Swal.fire({
                title: `Quantidade (${coinSymbol})`,
                background: '#1b1b1b',
                color: '#fff',
                html: `
            <input id="swal-input-amount" class="swal2-input" type="number"
                placeholder="0.01" min="0.00000001" step="0.00000001"
                style="border-radius: 10px;
                        background: #111;
                        border: 1px solid #333;
                        color: #fff;
                        width: 70%;
                        height: 50px;
                        overflow: hidden;
                        scrollbar-width: none;
                        -ms-overflow-style: none;
                        text-align: center;">
            <div id="swal-equivalent"
                style="color: #8ae2fc;font-size: .9rem;margin-top: 5px;">Equivalente: R$ 0,00</div>
            <div style="color: #fceb8a;font-size: .8rem;margin-top: 10px;">Saldo disponível: ${coin.quantidade.toFixed(8)} ${coinSymbol}</div>
        `,
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-send-fill" style="margin-right: 5px;"></i> Transferir',
                cancelButtonText: 'Voltar',
                preConfirm: () => {
                    const v = parseFloat(document.getElementById('swal-input-amount').value);
                    if (!v || isNaN(v) || v <= 0) {
                        Swal.showValidationMessage('Quantidade inválida.');
                        return false;
                    }
                    if (v > coin.quantidade) {
                        Swal.showValidationMessage('Saldo insuficiente!');
                        return false;
                    }
                    return v;
                },
                didOpen: () => {
                    const inp = document.getElementById('swal-input-amount'),
                        eq = document.getElementById('swal-equivalent');

                    inp.addEventListener('input', () => {
                        const v = parseFloat(inp.value) || 0;
                        eq.textContent = `Equivalente: ${formatBRL(v * currentPrice)}`;
                    });

                    inp.focus();

                    const container = Swal.getPopup();
                    container.style.overflow = 'hidden';
                    container.style.maxHeight = '100%';
                }
            });
            if (!amount) return;

            // **AQUI: Inicia o modal de autenticação antes de chamar a biometria**
            const authModal = Swal.fire({
                title: 'Autenticando Transferência',
                html: 'Confirme a transação com a biometria do dispositivo.',
                background: '#1b1b1b',
                color: '#fff',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                    const container = Swal.getHtmlContainer();
                    if (container) {
                        container.style.paddingBottom = '30px'; // Ajuste de visual
                    }
                }
            });

            let erro = null;

            try {
                // **AQUI É ONDE A BIOMETRIA É CHAMADA (WebAuthn)**
                await Promise.race([
                    navigator.credentials.get({
                        publicKey: { challenge: new Uint8Array(32), timeout: 30000, userVerification: 'required' }
                    }),
                    new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 30000))
                ]);
            } catch (e) {
                erro = e;
            }

            // Fecha o modal de "Autenticando Transferência"
            Swal.close(authModal);

            if (erro) {
                const isTimeout = erro.message === 'timeout';
                return Swal.fire({
                    icon: 'error',
                    background: '#1b1b1b',
                    color: '#fff',
                    title: 'Erro de Autenticação',
                    text: isTimeout ? 'Tempo esgotado ou biometria não suportada.' : 'Autenticação não realizada. Tente novamente.',
                    timer: 3000,
                    showConfirmButton: false
                });
            }

            const valorBRL = amount * currentPrice;
            coin.quantidade = Math.max(0, coin.quantidade - amount);
            carregarCarteira();

            Swal.fire({
                title: 'Transferência concluída!',
                icon: 'success',
                background: '#1b1b1b',
                color: '#fff',
                html: `
            <div style="text-align:left;">
                <div style="margin-bottom:8px;">
                    <strong>Moeda:</strong> ${coinName} (${coinSymbol})
                </div>
                <div style="margin-bottom:8px;">
                    <strong>Endereço:</strong><br>
                    <span style="opacity:.8">${address}</span>
                </div>
                <div style="margin-bottom:8px;">
                    <strong>Quantidade:</strong> ${amount} ${coinSymbol}
                </div>
                <div>
                    <strong>Valor:</strong> ${formatBRL(valorBRL)}
                </div>
            </div>
        `,
                confirmButtonText: 'Fechar',
            });
        }

        // --- Nova Função para Autenticação Inicial ---

        function liberarAcesso() {
            const overlay = document.getElementById('biometric-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }
            carregarCarteira(); // Inicia o carregamento real após o desbloqueio
            setInterval(carregarCarteira, 60000);
        }

        async function protegerAcesso() {
            if (!window.PublicKeyCredential || !navigator.credentials.get) {
                // Se não houver suporte, libera o acesso imediatamente (ou insira outra lógica de login)
                console.warn("WebAuthn (Biometria) não suportada. Liberando acesso.");
                liberarAcesso();
                return;
            }

            const pulseAnimation = `
            @keyframes pulse {
                0% { transform: scale(1); opacity: 0.8; }
                50% { transform: scale(1.1); opacity: 1; }
                100% { transform: scale(1); opacity: 0.8; }
            }
        `;

            // 1. Cria o Overlay para Bloquear a Aplicação
            const overlay = document.createElement('div');
            overlay.id = 'biometric-overlay';
            overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 99999;
            color: #fff; transition: opacity 0.5s;
        `;

            // 2. Cria os Elementos de Autenticação
            const authIcon = document.createElement('span');
            authIcon.className = 'material-icons-outlined';
            authIcon.textContent = 'fingerprint';
            authIcon.style.cssText = 'font-size: 80px; color: #00ff00; margin-bottom: 20px; animation: pulse 1.5s infinite;';

            const authMessage = document.createElement('div');
            authMessage.textContent = 'Toque para liberar o acesso com Biometria';
            authMessage.style.cssText = 'font-size: 1.1rem; color: #aaa; margin-bottom: 30px;';

            const authButton = document.createElement('button');
            authButton.textContent = 'Autenticar';
            authButton.style.cssText = 'padding: 15px 30px; border: none; border-radius: 10px; background: #00ff00; color: #111; font-size: 1rem; cursor: pointer; transition: background 0.3s;';
            authButton.onmouseover = () => authButton.style.background = '#00cc00';
            authButton.onmouseout = () => authButton.style.background = '#00ff00';

            overlay.appendChild(authIcon);
            overlay.appendChild(authMessage);
            overlay.appendChild(authButton);
            document.body.appendChild(overlay);

            // Adiciona o estilo de animação
            const style = document.createElement('style');
            style.textContent = pulseAnimation;
            document.head.appendChild(style);

            // 3. Função de Autenticação
            const autenticarBiometria = async () => {
                authMessage.textContent = 'Aguardando biometria do dispositivo...';
                authButton.disabled = true;
                authButton.style.opacity = '0.7';

                try {
                    // **AQUI É A CHAMADA PRINCIPAL DA BIOMETRIA (WebAuthn)**
                    await navigator.credentials.get({
                        publicKey: {
                            challenge: new Uint8Array(32),
                            timeout: 30000,
                            userVerification: 'required'
                        }
                    });

                    // SUCESSO
                    authIcon.textContent = 'lock_open';
                    authIcon.style.color = '#00ff00';
                    authIcon.style.animation = 'none';
                    authMessage.textContent = 'Acesso liberado!';

                    // Remove o overlay após um breve delay de sucesso
                    setTimeout(liberarAcesso, 500);

                } catch (e) {
                    // FALHA (cancelamento, timeout, erro)
                    console.error('Falha na autenticação:', e);
                    authIcon.textContent = 'lock';
                    authIcon.style.color = '#ff0000';
                    authMessage.textContent = 'Falha na autenticação. Tente novamente.';
                    authButton.disabled = false;
                    authButton.style.opacity = '1';
                    authIcon.style.animation = 'pulse 1.5s infinite';
                }
            };

            authButton.onclick = autenticarBiometria;
        }

        // --- FIM da Função de Autenticação Inicial ---


        async function iniciarApp() {
            const carregouSalvo = carregarCarteiraStorage();

            if (!carregouSalvo) {
                preCarregarCarteiraSimulada();
            }

            document.getElementById('appContainer').style.display = 'flex';

            // Chamada de proteção de acesso
            await protegerAcesso();

            // Se `protegerAcesso` falhar ou liberar o acesso, o código continua em `liberarAcesso()`
            // A lógica de carregamento e timer que estava aqui foi movida para `liberarAcesso()`
        }

        window.addEventListener('load', () => {
            exibirTotalMoedas();
            iniciarApp();
        });

        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });
        });
        navItems[1].classList.add('active');

        function exibirTotalMoedas() {
            const totalMoedas = investimentos.length;
            const totalMoedasEl = document.getElementById('totalMoedasInvestidas');

            if (totalMoedasEl) {
                totalMoedasEl.textContent = totalMoedas;
            }
        }
    </script>
</body>

</html>